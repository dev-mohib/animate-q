import{r as o,F as L,n as R,u as z,c as E,b as B,j as H,o as M}from"./app-ab14aff0.js";import{h as y}from"./UndoRedo-dbba45c1.js";const{fabric:c}=M,Y=({tState:D,tActions:S})=>{const[l,_]=o.useState(!1),[g,F]=o.useState(!1),t=o.useContext(L),O=o.useContext(R),C=z(),[b,P]=o.useState({x:0,y:0}),{threads:n,activeThread:r}=D,{brushColor:m,bgColor:u,brushWidth:h}=E(e=>e.editorSlice),{drawTool:f,threadLayersView:p,isResized:T,isThreadShow:x}=E(e=>e.uiSlice);o.useEffect(()=>{const e=new c.Canvas("myCanvas",{width:window.innerWidth,height:window.innerHeight,backgroundColor:u,stateful:!1,isDrawingMode:!0,enableRetinaScaling:!1,selection:!1,allowTouchScrolling:!1,renderOnAddRemove:!1,enablePointerEvents:!0});c.Object.prototype.objectCaching=!1,c.Object.prototype.hasBorders=!1,c.Object.prototype.hasControls=!1,c.Object.prototype.statefullCache=!1,c.Object.prototype.selectable=!1;let a=new c.PencilBrush(e);a.initialize(e),a.color=m,a.width=h,e.freeDrawingBrush=a;const s=new c.Circle({opacity:0,left:0,top:0,radius:1,visible:!1,data:{activeThread:0,activeFrame:0},fill:"red"});e.add(s),O(e),e.on("mouse:wheel",function(i){var w=i.e.deltaY,d=e.getZoom();d*=.999**w,d>20&&(d=20),d<.01&&(d=.01),e.zoomToPoint({x:i.e.offsetX,y:i.e.offsetY},d),i.e.preventDefault(),i.e.stopPropagation()}),e.on("mouse:down",i=>{F(!0)}),e.on("mouse:up",i=>{F(!1)}),e.on("mouse:move",i=>{P({x:i.e.clientX,y:i.e.clientY})}),_(!0)},[]);const v=(e=0,a=0)=>t._objects.filter(s=>{var i,w;return((i=s==null?void 0:s.data)==null?void 0:i.activeThread)==e&&((w=s==null?void 0:s.data)==null?void 0:w.activeFrame)==a}),k=(e=0)=>t._objects.filter(a=>(a==null?void 0:a.data.activeFrame)==e),A=e=>t._objects.filter(a=>a.name==e);return o.useEffect(()=>{l&&t.setDimensions({width:window.innerWidth,height:window.innerHeight})},[T]),o.useEffect(()=>{if(l){if(t.backgroundColor=u,A("eraser").forEach(e=>{e.stroke=u,e.dirty=!0}),f=="brush"){t.isDrawingMode=!0,t.freeDrawingBrush.color=m,t.freeDrawingBrush.width=h;try{t.__eventListeners["path:created"]=[]}catch{}}else f=="eraser"&&(t.freeDrawingBrush.color=u,t.freeDrawingBrush.width=h);t.renderAll()}},[m,h,u,f,l]),o.useEffect(()=>{if(l){const e=new c.Circle({fill:m,left:b.x,top:b.y,radius:h/2});n[r].isPlaying?(t.isDrawingMode=!1,g&&f=="brush"&&t.add(e)):!n[r].isPlaying&&!g&&(t.isDrawingMode=!0)}},[l,r,n[r],g]),o.useEffect(()=>{l&&(t.__eventListeners["object:added"]=[],t.on("object:added",e=>{y.isLocked||(e.target.name=f,e.target.data={activeThread:r,activeFrame:n[r??0].activeFrame},v(r,n[r].activeFrame).length&&S.fillFrame(r,n[r].activeFrame),C(B.enableUndo()),y.undoHistory.push(t.toJSON(["data"])),y.redoHistory=[],C(B.disableRedo()))}))},[r,n[r],l,f]),o.useEffect(()=>{if(l){const e=n[r??0];t._objects.forEach(a=>{a.visible=!1,a.name!=="eraser"&&a.sendToBack()}),x?v(r,n[r].activeFrame).forEach(a=>{if(a.visible=!0,a.name!=="eraser"&&a.sendToBack(),a.opacity=1,!e.isPlaying)if(p=="Next"){const s=e.activeFrame==e.frames.length-1?0:e.activeFrame+1;v(r,s).forEach(i=>{i.visible=!0,i.opacity=.3})}else if(p=="Previous"){const s=e.activeFrame==0?e.frames.length-1:e.activeFrame-1;v(r,s).forEach(i=>{i.visible=!0,i.selectable=!1,i.opacity=.3})}else k(e.activeFrame).forEach(s=>{s.visible=!0})}):n.forEach(a=>{v(a.index,a.activeFrame).forEach(s=>{s.name!=="eraser"&&s.sendToBack(),s.visible=!0,s.opacity=1})}),t.renderAll()}},[r,n[r],p,x]),H.jsx("canvas",{id:"myCanvas"})};export{Y as default};
