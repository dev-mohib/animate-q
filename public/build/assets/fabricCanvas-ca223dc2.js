import{r as o,F as A,n as L,u as R,c as E,b as D,j as z,o as H}from"./app-ab66af2d.js";import{h as y}from"./UndoRedo-d5e660ab.js";const{fabric:c}=H,W=({tState:B,tActions:S})=>{const[l,P]=o.useState(!1),[g,C]=o.useState(!1),i=o.useContext(A),T=o.useContext(L),b=R(),[F,_]=o.useState({x:0,y:0}),{threads:n,activeThread:s}=B,{brushColor:m,bgColor:u,brushWidth:h}=E(e=>e.editorSlice),{drawTool:f,threadLayersView:p,isResized:O,isThreadShow:x}=E(e=>e.uiSlice);o.useEffect(()=>{const e=new c.Canvas("myCanvas",{width:window.innerWidth,height:window.innerHeight,backgroundColor:u,stateful:!1,isDrawingMode:!0,enableRetinaScaling:!1,selection:!1,allowTouchScrolling:!1,renderOnAddRemove:!1,enablePointerEvents:!0});c.Object.prototype.objectCaching=!1,c.Object.prototype.hasBorders=!1,c.Object.prototype.hasControls=!1,c.Object.prototype.statefullCache=!1,c.Object.prototype.selectable=!1;let a=new c.PencilBrush(e);a.initialize(e),a.color=m,a.width=h,e.freeDrawingBrush=a;const r=new c.Circle({opacity:0,left:0,top:0,radius:1,visible:!1,data:{activeThread:0,activeFrame:0},fill:"red"});e.add(r),T(e),e.on("mouse:wheel",function(t){var w=t.e.deltaY,d=e.getZoom();d*=.999**w,d>20&&(d=20),d<.01&&(d=.01),e.zoomToPoint({x:t.e.offsetX,y:t.e.offsetY},d),t.e.preventDefault(),t.e.stopPropagation()}),e.on("mouse:down",t=>{C(!0)}),e.on("mouse:up",t=>{C(!1)}),e.on("mouse:move",t=>{_({x:t.e.clientX,y:t.e.clientY})}),P(!0)},[]);const v=(e=0,a=0)=>i._objects.filter(r=>{var t,w;return((t=r==null?void 0:r.data)==null?void 0:t.activeThread)==e&&((w=r==null?void 0:r.data)==null?void 0:w.activeFrame)==a}),k=e=>i._objects.filter(a=>a.name==e);return o.useEffect(()=>{l&&i.setDimensions({width:window.innerWidth,height:window.innerHeight})},[O]),o.useEffect(()=>{if(l){if(i.backgroundColor=u,k("eraser").forEach(e=>{e.stroke=u,e.dirty=!0}),f=="brush"){i.isDrawingMode=!0,i.freeDrawingBrush.color=m,i.freeDrawingBrush.width=h;try{i.__eventListeners["path:created"]=[]}catch{}}else f=="eraser"&&(i.freeDrawingBrush.color=u,i.freeDrawingBrush.width=h);i.renderAll()}},[m,h,u,f,l]),o.useEffect(()=>{if(l){const e=new c.Circle({fill:m,left:F.x,top:F.y,radius:h/2});n[s].isPlaying?(i.isDrawingMode=!1,g&&f=="brush"&&i.add(e)):!n[s].isPlaying&&!g&&(i.isDrawingMode=!0)}},[l,s,n[s],g]),o.useEffect(()=>{l&&(i.__eventListeners["object:added"]=[],i.on("object:added",e=>{y.isLocked||(e.target.name=f,e.target.data={activeThread:s,activeFrame:n[s??0].activeFrame},v(s,n[s].activeFrame).length&&S.fillFrame(s,n[s].activeFrame),b(D.enableUndo()),y.undoHistory.push(i.toJSON(["data"])),y.redoHistory=[],b(D.disableRedo()))}))},[s,n[s],l,f]),o.useEffect(()=>{if(l){const e=n[s??0];i._objects.forEach(a=>{a.visible=!1,a.name!=="eraser"&&a.sendToBack()}),x?v(s,n[s].activeFrame).forEach(a=>{if(a.visible=!0,a.name!=="eraser"&&a.sendToBack(),a.opacity=1,!e.isPlaying){if(p=="Next"){const r=e.activeFrame==e.frames.length-1?0:e.activeFrame+1;v(s,r).forEach(t=>{t.visible=!0,t.opacity=.3})}else if(p=="Previous"){const r=e.activeFrame==0?e.frames.length-1:e.activeFrame-1;v(s,r).forEach(t=>{t.visible=!0,t.selectable=!1,t.opacity=.3})}}}):n.forEach(a=>{v(a.index,a.activeFrame).forEach(r=>{r.name!=="eraser"&&r.sendToBack(),r.visible=!0,r.opacity=1})}),i.renderAll()}},[s,n[s],p,x]),z.jsx("canvas",{id:"myCanvas"})};export{W as default};
