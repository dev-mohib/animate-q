import{r as c,F as z,b as R,u as j,c as B,e as _,j as C,f as H,a as M}from"./app-cec88a7a.js";import{h as D,C as W}from"./controls-21c7480d.js";const{fabric:g}=H,N=({tState:u,tActions:o})=>{const[h,y]=c.useState(!1),[t,s]=c.useState(!1),e=c.useContext(z),r=c.useContext(R),l=j(),[m,O]=c.useState({x:0,y:0}),{threads:f,activeThread:d}=u,{brushColor:v,bgColor:b,brushWidth:P,brushShadow:E}=B(a=>a.editorSlice),{drawTool:F,threadLayersView:S,isResized:L}=B(a=>a.uiSlice),T=(a,i)=>e._objects.filter(n=>n.data.activeThread==a&&n.data.activeFrame==i),k=a=>e._objects.filter(i=>i.name==a);return c.useEffect(()=>{const a=new g.Canvas("myCanvas",{width:window.innerWidth,height:window.innerHeight,backgroundColor:b,stateful:!1,isDrawingMode:!0,enableRetinaScaling:!1,selection:!1,allowTouchScrolling:!1,renderOnAddRemove:!1,enablePointerEvents:!0});g.Object.prototype.objectCaching=!1,g.Object.prototype.hasBorders=!1,g.Object.prototype.hasControls=!1,g.Object.prototype.statefullCache=!1;let i=new g.PencilBrush(a);i.initialize(a),i.color=v,i.width=P,a.freeDrawingBrush=i,r(a),a.on("mouse:wheel",function(n){var x=n.e.deltaY,p=a.getZoom();p*=.999**x,p>20&&(p=20),p<.01&&(p=.01),a.zoomToPoint({x:n.e.offsetX,y:n.e.offsetY},p),n.e.preventDefault(),n.e.stopPropagation()}),a.on("mouse:down",n=>{s(!0)}),a.on("mouse:up",n=>{s(!1)}),a.on("mouse:move",n=>{O({x:n.e.clientX,y:n.e.clientY})}),y(!0)},[]),c.useEffect(()=>{var a=(screen.orientation||{}).type||screen.mozOrientation||screen.msOrientation;a=="portrait-primary"||a=="portrait-secondary"?(e.width=window.innerWidth,e.height=window.innerHeight):(a=="landscape-primary"||a=="landscape-secondary")&&(e.width=window.innerHeight,e.height=window.innerWidth),e.renderAll()},[L]),c.useEffect(()=>{if(h){if(e.backgroundColor=b,k("eraser").forEach(a=>{a.stroke=b,a.dirty=!0}),F=="brush"){e.isDrawingMode=!0,e.freeDrawingBrush.color=v,e.freeDrawingBrush.shadow=E;try{e.__eventListeners["path:created"]=[]}catch{}}else F=="eraser"?(e.freeDrawingBrush.color=b,e.freeDrawingBrush.shadow=null):(e.isDrawingMode=!0,e.__eventListeners["path:created"]=[],e.on("path:created",function(a){var i=a.path;i.set("fill",v),e.clipTo=function(n){i.render(n)}}));e.renderAll()}},[v,P,b,F,h,E]),c.useEffect(()=>{var a,i;if(h){const n=new g.Circle({fill:v,left:m.x,top:m.y,radius:P/2,shadow:E});(a=f[d])!=null&&a.isPlaying?(e.isDrawingMode=!1,t&&F=="brush"&&e.add(n)):!((i=f[d])!=null&&i.isPlaying)&&!t&&(e.isDrawingMode=!0)}},[h,d,f[d],t,E]),c.useEffect(()=>{h&&(e.__eventListeners["object:added"]=[],e.on("object:added",a=>{a.target.name=F,a.target.data={activeThread:d,activeFrame:f[d??0].activeFrame},T(d,f[d].activeFrame).length&&o.fillFrame(d,f[d].activeFrame),D.isLocked||(l(_.enableUndo()),D.undoHistory.push(e.toJSON()),D.redoHistory=[],l(_.disableRedo()))}))},[d,f[d],h]),c.useEffect(()=>{if(h){const a=f[d??0];e._objects.forEach(i=>{i.sendToBack(),i.visible=!1,i.selectable=!1}),f.forEach((i,n)=>{T(n,i.activeFrame).forEach((x,p)=>{if(x.sendToBack(),x.visible=!0,x.opacity=1,!a.isPlaying){if(S=="Next"){const A=a.activeFrame==a.frames.length-1?0:a.activeFrame+1;T(d,A).forEach(w=>{w.visible=!0,w.opacity=.3})}else if(S=="Previous"){const A=a.activeFrame==0?a.frames.length-1:a.activeFrame-1;T(d,A).forEach(w=>{w.visible=!0,w.selectable=!1,w.opacity=.3})}}})}),e.renderAll()}},[d,f,S]),C.jsx("canvas",{id:"myCanvas"})};const X=()=>{const[u,o]=c.useState({activeThread:0,isPlayAll:!1,threads:[]}),h=j(),y={pushThread:t=>{o(s=>({...s,threads:[...u.threads,t]}))},reOrderThreads:t=>{o({...u,threads:t})},popThread:()=>{u.threads.length>1&&o(t=>({...t,threads:t.threads.filter((s,e)=>e!=t.threads.length-1)}))},pauseThread:t=>{o(s=>({...s,threads:s.threads.map((e,r)=>r==t?{...e,isPlaying:!1}:{...e})}))},playThread:t=>{o(s=>({...s,threads:s.threads.map((e,r)=>r==t?{...e,isPlaying:!0}:{...e})}))},setActiveThread:t=>{o(s=>({...s,activeThread:t}))},setDegreeOfOrigin:(t,s)=>{o(e=>({...e,threads:e.threads.map((r,l)=>l==s?{...r,degreeOfOrigin:t}:r)}))},setActiveFrame:(t,s)=>{o(e=>({...e,threads:e.threads.map((r,l)=>l==t?{...r,activeFrame:s}:r)}))},setFps:(t,s)=>{t=="increase"?o(e=>({...e,threads:e.threads.map((r,l)=>l==s?{...r,fps:r.fps<30?r.fps+5:r.fps}:{...r})})):o(e=>({...e,threads:e.threads.map((r,l)=>l==s?{...r,fps:r.fps>5?r.fps-5:r.fps}:{...r})}))},playAll:()=>{o(t=>({...t,threads:t.threads.map(s=>({...s,isPlaying:!0}))}))},pauseAll:()=>{o(t=>({...t,threads:t.threads.map(s=>({...s,isPlaying:!1}))}))},pushFrame:t=>{o(s=>({...s,threads:s.threads.map((e,r)=>r==t?{...e,frames:[...e.frames,{isFilled:!1}]}:e)}))},popFrame:t=>{o(s=>({...s,threads:s.threads.map((e,r)=>r==t?{...e,frames:e.frames.filter((l,m)=>m!=e.frames.length-1)}:e)}))},fillFrame:(t,s)=>{o(e=>({...e,threads:e.threads.map((r,l)=>l==t?{...r,frames:r.frames.map((m,O)=>O==s?{...m,isFilled:!0}:m)}:r)}))},unfillFrame:t=>{},getState:()=>u};return c.useEffect(()=>{window.addEventListener("orientationchange",t=>{h(_.setWindowResized())}),y.pushThread({fps:15,index:0,isActive:!1,isPlaying:!1,degreeOfOrigin:0,frames:[{isFilled:!1}],activeFrame:0})},[]),C.jsxs("div",{className:"bg-black",children:[C.jsx(M,{title:"Editor"}),C.jsx(N,{tState:u,tActions:y}),C.jsx(W,{threadState:u,actions:y})]})};export{X as default};
