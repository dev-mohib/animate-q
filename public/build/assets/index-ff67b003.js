import{r as l,F as z,b as R,u as j,c as B,e as _,j as C,f as H,a as M}from"./app-e607fc44.js";import{h as D,C as W}from"./controls-77492b10.js";const{fabric:g}=H,N=({tState:u,tActions:o})=>{const[h,y]=l.useState(!1),[t,s]=l.useState(!1),e=l.useContext(z);l.useState(null);const r=l.useContext(R),c=j(),[m,T]=l.useState({x:0,y:0}),{threads:f,activeThread:d}=u,{brushColor:v,bgColor:b,brushWidth:O,brushShadow:E}=B(a=>a.editorSlice),{drawTool:F,threadLayersView:P,isThreadShow:I,isResized:L}=B(a=>a.uiSlice);l.useEffect(()=>{const a=new g.Canvas("myCanvas",{width:window.innerWidth,height:window.innerHeight,backgroundColor:b,stateful:!1,isDrawingMode:!0,enableRetinaScaling:!1,selection:!1,allowTouchScrolling:!1,renderOnAddRemove:!1,enablePointerEvents:!0});g.Object.prototype.objectCaching=!1,g.Object.prototype.hasBorders=!1,g.Object.prototype.hasControls=!1,g.Object.prototype.statefullCache=!1;let i=new g.PencilBrush(a);i.initialize(a),i.color=v,i.width=O,a.freeDrawingBrush=i,r(a),a.on("mouse:wheel",function(n){var x=n.e.deltaY,p=a.getZoom();p*=.999**x,p>20&&(p=20),p<.01&&(p=.01),a.zoomToPoint({x:n.e.offsetX,y:n.e.offsetY},p),n.e.preventDefault(),n.e.stopPropagation()}),a.on("mouse:down",n=>{s(!0)}),a.on("mouse:up",n=>{s(!1)}),a.on("mouse:move",n=>{T({x:n.e.clientX,y:n.e.clientY})}),y(!0)},[]);const S=(a,i)=>e._objects.filter(n=>n.data.activeThread==a&&n.data.activeFrame==i),k=a=>e._objects.filter(i=>i.name==a);return l.useEffect(()=>{var a=(screen.orientation||{}).type||screen.mozOrientation||screen.msOrientation;a=="portrait-primary"||a=="portrait-secondary"?(e.width=window.innerWidth,e.height=window.innerHeight):(a=="landscape-primary"||a=="landscape-secondary")&&(e.width=window.innerHeight,e.height=window.innerWidth),e.renderAll()},[L]),l.useEffect(()=>{if(h){if(e.backgroundColor=b,k("eraser").forEach(a=>{a.stroke=b,a.dirty=!0}),F=="brush"){e.isDrawingMode=!0,e.freeDrawingBrush.color=v,e.freeDrawingBrush.shadow=E;try{e.__eventListeners["path:created"]=[]}catch{}}else F=="eraser"?(e.freeDrawingBrush.color=b,e.freeDrawingBrush.shadow=null):(e.isDrawingMode=!0,e.__eventListeners["path:created"]=[],e.on("path:created",function(a){var i=a.path;i.set("fill",v),e.clipTo=function(n){i.render(n)}}));e.renderAll()}},[v,O,b,F,h,E]),l.useEffect(()=>{var a,i;if(h){const n=new g.Circle({fill:v,left:m.x,top:m.y,radius:O/2,shadow:E});(a=f[d])!=null&&a.isPlaying?(e.isDrawingMode=!1,t&&F=="brush"&&e.add(n)):!((i=f[d])!=null&&i.isPlaying)&&!t&&(e.isDrawingMode=!0)}},[h,d,f[d],t,E]),l.useEffect(()=>{h&&(e.__eventListeners["object:added"]=[],e.on("object:added",a=>{a.target.name=F,a.target.data={activeThread:d,activeFrame:f[d??0].activeFrame},S(d,f[d].activeFrame).length&&o.fillFrame(d,f[d].activeFrame),D.isLocked||(c(_.enableUndo()),D.undoHistory.push(e.toJSON()),D.redoHistory=[],c(_.disableRedo()))}))},[d,f[d],h]),l.useEffect(()=>{if(h){const a=f[d??0];e._objects.forEach(i=>{i.sendToBack(),i.visible=!1,i.selectable=!1}),f.forEach((i,n)=>{S(n,i.activeFrame).forEach((x,p)=>{if(x.sendToBack(),x.visible=!0,x.opacity=1,!a.isPlaying){if(P=="Next"){const A=a.activeFrame==a.frames.length-1?0:a.activeFrame+1;S(d,A).forEach(w=>{w.visible=!0,w.opacity=.3})}else if(P=="Previous"){const A=a.activeFrame==0?a.frames.length-1:a.activeFrame-1;S(d,A).forEach(w=>{w.visible=!0,w.selectable=!1,w.opacity=.3})}}})}),e.renderAll()}},[d,f,P]),C.jsx("canvas",{id:"myCanvas"})};const J=()=>{const[u,o]=l.useState({activeThread:0,isPlayAll:!1,threads:[]}),h=j(),y={pushThread:t=>{o(s=>({...s,threads:[...u.threads,t]}))},popThread:()=>{u.threads.length>1&&o(t=>({...t,threads:t.threads.filter((s,e)=>e!=t.threads.length-1)}))},pauseThread:t=>{o(s=>({...s,threads:s.threads.map((e,r)=>r==t?{...e,isPlaying:!1}:{...e})}))},playThread:t=>{o(s=>({...s,threads:s.threads.map((e,r)=>r==t?{...e,isPlaying:!0}:{...e})}))},setActiveThread:t=>{o(s=>({...s,activeThread:t}))},setDegreeOfOrigin:(t,s)=>{o(e=>({...e,threads:e.threads.map((r,c)=>c==s?{...r,degreeOfOrigin:t}:r)}))},setActiveFrame:(t,s)=>{o(e=>({...e,threads:e.threads.map((r,c)=>c==t?{...r,activeFrame:s}:r)}))},setFps:(t,s)=>{t=="increase"?o(e=>({...e,threads:e.threads.map((r,c)=>c==s?{...r,fps:r.fps<30?r.fps+5:r.fps}:{...r})})):o(e=>({...e,threads:e.threads.map((r,c)=>c==s?{...r,fps:r.fps>5?r.fps-5:r.fps}:{...r})}))},playAll:()=>{o(t=>({...t,threads:t.threads.map(s=>({...s,isPlaying:!0}))}))},pauseAll:()=>{o(t=>({...t,threads:t.threads.map(s=>({...s,isPlaying:!1}))}))},pushFrame:t=>{o(s=>({...s,threads:s.threads.map((e,r)=>r==t?{...e,frames:[...e.frames,{isFilled:!1}]}:e)}))},popFrame:t=>{o(s=>({...s,threads:s.threads.map((e,r)=>r==t?{...e,frames:e.frames.filter((c,m)=>m!=e.frames.length-1)}:e)}))},fillFrame:(t,s)=>{o(e=>({...e,threads:e.threads.map((r,c)=>c==t?{...r,frames:r.frames.map((m,T)=>T==s?{...m,isFilled:!0}:m)}:r)}))},unfillFrame:t=>{},getState:()=>u};return l.useEffect(()=>{window.addEventListener("orientationchange",t=>{h(_.setWindowResized())}),y.pushThread({fps:15,index:0,isActive:!1,isPlaying:!1,degreeOfOrigin:0,frames:[{isFilled:!1}],activeFrame:0})},[]),C.jsxs("div",{className:"bg-black",children:[C.jsx(M,{title:"Editor"}),C.jsx(N,{tState:u,tActions:y}),C.jsx(W,{threadState:u,actions:y})]})};export{J as default};
