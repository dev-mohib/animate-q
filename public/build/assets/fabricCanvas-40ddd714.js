import{n as A,r as c,F as L,o as M,u as R,c as D,b as E,j as z}from"./app-a8171a9a.js";import{h as y}from"./UndoRedo-9dce11c5.js";const{fabric:l}=A,W=({tState:B,tActions:_})=>{const[f,S]=c.useState(!1),[m,b]=c.useState(!1),t=c.useContext(L),T=c.useContext(M),x=R(),[F,P]=c.useState({x:0,y:0}),{threads:n,activeThread:i}=B,{brushColor:d,bgColor:p,brushWidth:u}=D(e=>e.editorSlice),{drawTool:h,threadLayersView:g,isResized:O,isThreadShow:C}=D(e=>e.uiSlice);c.useEffect(()=>{const e=new l.Canvas("myCanvas",{width:window.innerWidth,height:window.innerHeight,backgroundColor:p,stateful:!1,isDrawingMode:!0,enableRetinaScaling:!1,selection:!1,allowTouchScrolling:!1,renderOnAddRemove:!1,enablePointerEvents:!0});l.Object.prototype.objectCaching=!1,l.Object.prototype.hasBorders=!1,l.Object.prototype.hasControls=!1,l.Object.prototype.statefullCache=!1,l.Object.prototype.selectable=!1;let a=new l.PencilBrush(e);a.initialize(e),a.color=d,a.width=u,e.freeDrawingBrush=a;const r=new l.Circle({opacity:0,left:0,top:0,radius:1,visible:!1,data:{activeThread:0,activeFrame:0},fill:"red"});e.add(r),T(e),e.on("mouse:wheel",function(s){var o=s.e.deltaY,v=e.getZoom();v*=.999**o,v>20&&(v=20),v<.01&&(v=.01),e.zoomToPoint({x:s.e.offsetX,y:s.e.offsetY},v),s.e.preventDefault(),s.e.stopPropagation()}),e.on("mouse:down",s=>{b(!0)}),e.on("mouse:up",s=>{b(!1)}),e.on("mouse:move",s=>{P({x:s.e.clientX,y:s.e.clientY})}),S(!0)},[]);const w=(e=0,a=0)=>t._objects.filter(r=>{var s,o;return((s=r==null?void 0:r.data)==null?void 0:s.activeThread)==e&&((o=r==null?void 0:r.data)==null?void 0:o.activeFrame)==a}),k=e=>t._objects.filter(a=>a.name==e);return c.useEffect(()=>{f&&t.setDimensions({width:window.innerWidth,height:window.innerHeight})},[O]),c.useEffect(()=>{if(f){if(t.backgroundColor=p,k("eraser").forEach(e=>{e.stroke=p,e.dirty=!0}),h=="brush"){t.isDrawingMode=!0,t.freeDrawingBrush.color=d,t.freeDrawingBrush.width=u;try{t.__eventListeners["path:created"]=[]}catch{}}else h=="eraser"?(t.freeDrawingBrush.color=p,t.freeDrawingBrush.width=u):(t.isDrawingMode=!0,t.freeDrawingBrush.color=d,t.freeDrawingBrush.width=u,t.__eventListeners["path:created"]=[],t.on("path:created",function(e){var a=e.path;a.set("fill",d),t.clipTo=function(r){a.render(r)}}));t.renderAll()}},[d,u,p,h,f]),c.useEffect(()=>{var e,a;if(f){const r=new l.Circle({fill:d,left:F.x,top:F.y,radius:u/2});(e=n[i])!=null&&e.isPlaying?(t.isDrawingMode=!1,m&&h=="brush"&&t.add(r)):!((a=n[i])!=null&&a.isPlaying)&&!m&&(t.isDrawingMode=!0)}},[f,i,n[i],m]),c.useEffect(()=>{f&&(t.__eventListeners["object:added"]=[],t.on("object:added",e=>{y.isLocked||(e.target.name=h,e.target.data={activeThread:i,activeFrame:n[i??0].activeFrame},w(i,n[i].activeFrame).length&&_.fillFrame(i,n[i].activeFrame),x(E.enableUndo()),y.undoHistory.push(t.toJSON(["data"])),y.redoHistory=[],x(E.disableRedo()))}))},[i,n[i],f,h]),c.useEffect(()=>{if(f){const e=n[i??0];t._objects.forEach(a=>{a.sendToBack(),a.visible=!1}),C?w(i,n[i].activeFrame).forEach((a,r)=>{if(a.sendToBack(),a.visible=!0,a.opacity=1,!e.isPlaying){if(g=="Next"){const s=e.activeFrame==e.frames.length-1?0:e.activeFrame+1;w(i,s).forEach(o=>{o.visible=!0,o.opacity=.3})}else if(g=="Previous"){const s=e.activeFrame==0?e.frames.length-1:e.activeFrame-1;w(i,s).forEach(o=>{o.visible=!0,o.selectable=!1,o.opacity=.3})}}}):n.forEach(a=>{w(a.index,a.activeFrame).forEach(r=>{r.sendToBack(),r.visible=!0,r.opacity=1})}),t.renderAll()}},[i,n,g,C]),z.jsx("canvas",{id:"myCanvas"})};export{l as Fabric,W as default};
